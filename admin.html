<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | Almanion</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #0f172a;
            --text: #f1f5f9;
            --text-secondary: #a8b8cc;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --border: #334155;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ============ –≠–ö–†–ê–ù –í–•–û–î–ê ============ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .login-card h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .login-card p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-outline {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border);
        }

        .btn-outline:hover {
            border-color: var(--text-secondary);
            color: var(--text);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        /* ============ DASHBOARD ============ */
        .dashboard {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.6rem;
        }

        .dashboard-header .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* ============ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ============ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
        }

        .stat-card.online::before { background: var(--success); }
        .stat-card.unique::before { background: var(--accent); }
        .stat-card.today::before { background: var(--warning); }
        .stat-card.pages::before { background: #a78bfa; }

        .stat-card .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.3rem;
        }

        .stat-card.online .stat-value { color: var(--success); }
        .stat-card.unique .stat-value { color: var(--accent); }
        .stat-card.today .stat-value { color: var(--warning); }
        .stat-card.pages .stat-value { color: #a78bfa; }

        .stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ============ –°–ï–ö–¶–ò–ò ============ */
        .section {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============ –¢–ê–ë–õ–ò–¶–ê –û–ù–õ–ê–ô–ù ============ */
        .online-table {
            width: 100%;
            border-collapse: collapse;
        }

        .online-table th, .online-table td {
            padding: 0.7rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .online-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .online-table tr:last-child td {
            border-bottom: none;
        }

        .online-table .device-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .device-mobile {
            background: rgba(249, 115, 22, 0.15);
            color: #fb923c;
        }

        .device-desktop {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .page-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            font-size: 0.95rem;
        }

        /* ============ –°–û–ó–î–ê–ù–ò–ï –û–ü–†–û–°–ê ============ */
        .poll-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .option-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .option-row input {
            flex: 1;
        }

        .option-row .remove-option {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .option-row .remove-option:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .add-option-btn {
            align-self: flex-start;
            padding: 0.5rem 1rem;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .add-option-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .poll-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* ============ –ê–ö–¢–ò–í–ù–´–ï –û–ü–†–û–°–´ ============ */
        .poll-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .poll-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .poll-card h4 {
            font-size: 1.05rem;
            margin-bottom: 0.25rem;
        }

        .poll-card .poll-status {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .poll-active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .poll-closed {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-secondary);
        }

        .poll-results {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .poll-result-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .poll-result-label {
            min-width: 120px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .poll-result-bar-container {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .poll-result-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            min-width: 2px;
        }

        .poll-result-bar.c0 { background: var(--accent); }
        .poll-result-bar.c1 { background: var(--success); }
        .poll-result-bar.c2 { background: var(--warning); }
        .poll-result-bar.c3 { background: #a78bfa; }
        .poll-result-bar.c4 { background: #f472b6; }
        .poll-result-bar.c5 { background: #34d399; }

        .poll-result-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .online-table {
                font-size: 0.8rem;
            }

            .online-table th, .online-table td {
                padding: 0.5rem;
            }

            .poll-result-label {
                min-width: 80px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============ LOADING ============ */
        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-right: 0.5rem;
            animation: pulse 1.5s infinite;
        }

        /* ============ –ò–ú–ï–ù–û–í–ê–ù–ò–ï –ü–û–°–ï–¢–ò–¢–ï–õ–ï–ô ============ */
        .visitor-name {
            cursor: pointer;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .visitor-name:hover {
            background: rgba(255,255,255,0.08);
        }

        .visitor-name .name-label {
            font-weight: 600;
            color: var(--accent-hover);
        }

        .visitor-name .name-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .visitor-name .edit-icon {
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .visitor-name:hover .edit-icon {
            opacity: 0.6;
        }

        /* ============ –ö–ù–û–ü–ö–ê –î–ï–ô–°–¢–í–ò–ô ============ */
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-hover);
        }

        /* ============ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ============ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            border: 1px solid var(--border);
        }

        .modal h3 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* ============ –î–ï–¢–ê–õ–ò –û–ü–†–û–°–ê ============ */
        .poll-details-toggle {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
            font-family: inherit;
            padding: 0.3rem 0;
            transition: color 0.2s;
        }

        .poll-details-toggle:hover {
            color: var(--accent-hover);
        }

        .poll-voter-list {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: none;
        }

        .poll-voter-list.open {
            display: block;
        }

        .poll-voter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .poll-voter-row:last-child {
            border-bottom: none;
        }

        .poll-voter-name {
            font-weight: 600;
            color: var(--text);
        }

        .poll-voter-answer {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* ============ –í–´–ë–û–† –ü–û–õ–£–ß–ê–¢–ï–õ–Ø ============ */
        .target-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .target-chip {
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .target-chip.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-hover);
        }

        .target-chip:hover {
            border-color: var(--accent);
        }

        /* ============ –ü–†–û–§–ò–õ–¨ –ü–û–°–ï–¢–ò–¢–ï–õ–Ø ============ */
        .profile-modal {
            max-width: 580px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .profile-modal .modal-body {
            overflow-y: auto;
            flex: 1;
            margin: 0 -2rem;
            padding: 0 2rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(59,130,246,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .profile-info h3 {
            font-size: 1.15rem;
            margin: 0 0 0.2rem 0;
        }

        .profile-info .profile-id {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .profile-section {
            margin-bottom: 1.25rem;
        }

        .profile-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.6rem;
        }

        .history-item {
            padding: 0.65rem 0.75rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .history-item .history-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .history-item .history-type {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .history-type-msg {
            background: rgba(59,130,246,0.15);
            color: var(--accent-hover);
        }

        .history-type-poll {
            background: rgba(167,139,250,0.15);
            color: #a78bfa;
        }

        .history-type-vote {
            background: rgba(34,197,94,0.15);
            color: var(--success);
        }

        .history-type-dm-poll {
            background: rgba(249,115,22,0.15);
            color: #fb923c;
        }

        .history-item .history-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-item .history-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .history-item .history-answer {
            margin-top: 0.25rem;
            font-size: 0.85rem;
            color: var(--success);
            font-weight: 600;
        }

        .history-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 1rem;
            font-size: 0.9rem;
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

    <!-- ============ –≠–ö–†–ê–ù –í–•–û–î–ê ============ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üîí –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p>Almanion Analytics</p>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="admin@example.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏</button>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <!-- ============ DASHBOARD ============ -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <h1>üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <div class="header-actions">
                <span style="font-size: 0.85rem; color: var(--text-secondary);" id="adminEmail"></span>
                <button class="btn btn-outline btn-sm" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
            <div class="stat-card online">
                <div class="stat-icon">üü¢</div>
                <div class="stat-value" id="onlineCount">‚Äî</div>
                <div class="stat-label">–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω</div>
            </div>
            <div class="stat-card unique">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="uniqueCount">‚Äî</div>
                <div class="stat-label">–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</div>
            </div>
            <div class="stat-card today">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="todayCount">‚Äî</div>
                <div class="stat-label">–°–µ–≥–æ–¥–Ω—è –ø–æ—Å–µ—Ç–∏–ª–æ</div>
            </div>
            <div class="stat-card pages">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-value" id="pagesCount">‚Äî</div>
                <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
            </div>
        </div>

        <!-- –ö—Ç–æ –æ–Ω–ª–∞–π–Ω -->
        <div class="section">
            <div class="section-title">
                <span class="status-dot"></span>
                –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω
            </div>
            <div style="overflow-x: auto;">
                <table class="online-table" id="onlineTable">
                    <thead>
                        <tr>
                            <th>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å</th>
                            <th>–°—Ç—Ä–∞–Ω–∏—Ü–∞</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="onlineTableBody">
                        <tr><td colspan="5" class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ -->
        <div class="section">
            <div class="section-title">üìù –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</div>
            <div class="poll-form" id="pollForm">
                <div class="form-group">
                    <label>–í–æ–ø—Ä–æ—Å</label>
                    <input type="text" id="pollQuestion" placeholder="–ß—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ –æ –Ω–æ–≤–æ–º –¥–∏–∑–∞–π–Ω–µ?">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="pollDescription" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –æ–ø—Ä–æ—Å—É...">
                </div>
                <div class="form-group">
                    <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤</label>
                    <div class="options-list" id="optionsList">
                        <div class="option-row">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1" class="poll-option">
                            <button class="remove-option" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </div>
                        <div class="option-row">
                            <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2" class="poll-option">
                            <button class="remove-option" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </div>
                    </div>
                    <button class="add-option-btn" id="addOptionBtn">+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
                </div>
                <div class="poll-actions">
                    <button class="btn btn-success" id="sendPollBtn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–ø—Ä–æ—Å—ã -->
        <div class="section">
            <div class="section-title">üìä –û–ø—Ä–æ—Å—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
            <div id="pollsList">
                <div class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================

        if (firebaseConfig.apiKey === "–í–°–¢–ê–í–¨_–°–í–û–ô_API_KEY") {
            document.querySelector('.login-card').innerHTML = `
                <h1>‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h1>
                <p style="color: #f59e0b;">Firebase –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω.<br>–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π <code>firebase-config.js</code></p>
            `;
        }

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ============================================
        // –ö–≠–® –ò–ú–Å–ù –ü–û–°–ï–¢–ò–¢–ï–õ–ï–ô
        // ============================================

        let visitorNamesCache = {};

        function loadVisitorNames() {
            db.ref('visitorNames').on('value', (snapshot) => {
                visitorNamesCache = snapshot.val() || {};
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º—ë–Ω
                if (lastOnlineSnapshot) renderOnlineTable(lastOnlineSnapshot);
            });
        }

        function getVisitorDisplayName(visitorId) {
            return visitorNamesCache[visitorId] || null;
        }

        function renameVisitor(visitorId) {
            const currentName = visitorNamesCache[visitorId] || '';
            const shortId = visitorId.substring(0, 15);
            const name = prompt(`–ò–º—è –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è ${shortId}‚Ä¶\n(–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å)`, currentName);
            if (name === null) return; // –û—Ç–º–µ–Ω–∞

            const action = name.trim() === ''
                ? db.ref('visitorNames/' + visitorId).remove()
                : db.ref('visitorNames/' + visitorId).set(name.trim());

            action.catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:', err);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firebase ‚Äî –Ω—É–∂–µ–Ω —É–∑–µ–ª visitorNames');
            });
        }

        // ============================================
        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        // ============================================

        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');

        loginBtn.addEventListener('click', login);
        document.getElementById('loginPassword').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') login();
        });
        document.getElementById('loginEmail').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });
        logoutBtn.addEventListener('click', () => auth.signOut());

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showLoginError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = '–í—Ö–æ–¥...';

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    loginError.style.display = 'none';
                })
                .catch((error) => {
                    let msg = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        msg = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    } else if (error.code === 'auth/too-many-requests') {
                        msg = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
                    } else if (error.code === 'auth/invalid-credential') {
                        msg = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    }
                    showLoginError(msg);
                    loginBtn.disabled = false;
                    loginBtn.textContent = '–í–æ–π—Ç–∏';
                });
        }

        function showLoginError(msg) {
            loginError.textContent = msg;
            loginError.style.display = 'block';
        }

        // –°–ª—É—à–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginScreen.style.display = 'none';
                dashboard.style.display = 'block';
                document.getElementById('adminEmail').textContent = user.email;
                initDashboard();
            } else {
                loginScreen.style.display = 'flex';
                dashboard.style.display = 'none';
                loginBtn.disabled = false;
                loginBtn.textContent = '–í–æ–π—Ç–∏';
            }
        });

        // ============================================
        // DASHBOARD: –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò
        // ============================================

        let dashboardInitialized = false;

        function initDashboard() {
            if (dashboardInitialized) return;
            dashboardInitialized = true;

            loadVisitorNames();
            listenOnlineUsers();
            loadUniqueVisitors();
            loadTodayVisitors();
            listenPolls();
            initPollForm();
        }

        // --- –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ---
        let lastOnlineSnapshot = null;

        function listenOnlineUsers() {
            db.ref('presence').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                lastOnlineSnapshot = data;

                const users = Object.values(data);
                document.getElementById('onlineCount').textContent = users.length;

                const pages = new Set(users.map(u => u.page));
                document.getElementById('pagesCount').textContent = pages.size;

                renderOnlineTable(data);
            });
        }

        function renderOnlineTable(data) {
            const users = Object.values(data || {});
            const tbody = document.getElementById('onlineTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω</td></tr>';
                return;
            }

            users.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            tbody.innerHTML = users.map(user => {
                const vid = user.visitorId || '?';
                const name = getVisitorDisplayName(vid);
                const shortId = vid.substring(0, 12);
                const isMobile = /Mobile|Android|iPhone|iPad/i.test(user.userAgent || '');
                const deviceClass = isMobile ? 'device-mobile' : 'device-desktop';
                const deviceLabel = isMobile ? 'üì± –ú–æ–±–∏–ª—å–Ω—ã–π' : 'üíª –î–µ—Å–∫—Ç–æ–ø';
                const page = (user.page || '/').replace(/^\//, '') || 'index';
                const pageDisplay = page.replace('.html', '');
                const timeAgo = getTimeAgo(user.timestamp);

                const nameHtml = name
                    ? `<span class="visitor-name" onclick="renameVisitor('${vid}')" title="–ö–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è">
                           <span class="name-label">${escapeHtml(name)}</span>
                           <span class="name-id">${shortId}‚Ä¶</span>
                           <span class="edit-icon">‚úèÔ∏è</span>
                       </span>`
                    : `<span class="visitor-name" onclick="renameVisitor('${vid}')" title="–ö–ª–∏–∫ –¥–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –∏–º–µ–Ω–∏">
                           <code style="font-size:0.8rem; color:var(--text-secondary)">${shortId}‚Ä¶</code>
                           <span class="edit-icon">‚úèÔ∏è</span>
                       </span>`;

                return `<tr>
                    <td>${nameHtml}</td>
                    <td><span class="page-badge">${escapeHtml(pageDisplay)}</span></td>
                    <td><span class="device-badge ${deviceClass}">${deviceLabel}</span></td>
                    <td style="color:var(--text-secondary)">${timeAgo}</td>
                    <td style="white-space:nowrap;">
                        <button class="action-btn" onclick="openVisitorProfile('${vid}')" title="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è">üìã</button>
                        <button class="action-btn" onclick="openDirectMessage('${vid}')" title="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">‚úâÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return '‚Äî';
            const diff = Math.floor((Date.now() - timestamp) / 1000);
            if (diff < 10) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 60) return `${diff}—Å –Ω–∞–∑–∞–¥`;
            if (diff < 3600) return `${Math.floor(diff / 60)}–º –Ω–∞–∑–∞–¥`;
            return `${Math.floor(diff / 3600)}—á –Ω–∞–∑–∞–¥`;
        }

        // --- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ ---
        function loadUniqueVisitors() {
            db.ref('visitors').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                document.getElementById('uniqueCount').textContent = Object.keys(data).length;
            });
        }

        // --- –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è ---
        function loadTodayVisitors() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('dailyStats/' + today).on('value', (snapshot) => {
                const data = snapshot.val() || {};
                document.getElementById('todayCount').textContent = Object.keys(data).length;
            });
        }

        // ============================================
        // –ü–†–û–§–ò–õ–¨ –ü–û–°–ï–¢–ò–¢–ï–õ–Ø (–ò–°–¢–û–†–ò–Ø)
        // ============================================

        function openVisitorProfile(visitorId) {
            const name = getVisitorDisplayName(visitorId);
            const displayName = name || visitorId.substring(0, 20) + '‚Ä¶';
            const existing = document.querySelector('.modal-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            overlay.innerHTML = `
                <div class="modal profile-modal">
                    <div class="profile-header">
                        <div class="profile-avatar">üë§</div>
                        <div class="profile-info">
                            <h3>${escapeHtml(displayName)}
                                <span class="edit-icon" style="cursor:pointer; font-size:0.8rem; opacity:0.5;" onclick="renameVisitor('${visitorId}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</span>
                            </h3>
                            <div class="profile-id">${escapeHtml(visitorId)}</div>
                        </div>
                    </div>
                    <div class="modal-body" id="profileBody">
                        <div class="history-empty pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
                    </div>
                    <div class="modal-actions" style="padding-top:1rem; border-top: 1px solid var(--border);">
                        <button class="btn btn-outline btn-sm" onclick="openDirectMessage('${visitorId}'); this.closest('.modal-overlay').remove();">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
                        <button class="btn btn-outline btn-sm" onclick="this.closest('.modal-overlay').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });

            document.body.appendChild(overlay);
            loadVisitorProfile(visitorId);
        }

        async function loadVisitorProfile(visitorId) {
            const body = document.getElementById('profileBody');
            if (!body) return;

            const allItems = [];

            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const dmSnap = await db.ref('directMessages/' + visitorId).once('value');
                const dms = dmSnap.val() || {};
                Object.entries(dms).forEach(([msgId, msg]) => {
                    if (msg.type === 'poll') {
                        allItems.push({
                            time: msg.timestamp || 0,
                            type: 'dm-poll',
                            typeLabel: 'üìä –õ–∏—á–Ω—ã–π –æ–ø—Ä–æ—Å',
                            text: msg.message,
                            extra: '–í–∞—Ä–∏–∞–Ω—Ç—ã: ' + (msg.options || []).join(', '),
                            read: msg.read
                        });
                    } else {
                        allItems.push({
                            time: msg.timestamp || 0,
                            type: 'msg',
                            typeLabel: 'üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ',
                            text: msg.message,
                            extra: null,
                            read: msg.read
                        });
                    }
                });

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–ø—Ä–æ—Å—ã
                const pollsSnap = await db.ref('polls').once('value');
                const polls = pollsSnap.val() || {};

                for (const [pollId, poll] of Object.entries(polls)) {
                    const respSnap = await db.ref('pollResponses/' + pollId + '/' + visitorId).once('value');
                    const resp = respSnap.val();
                    if (resp) {
                        allItems.push({
                            time: resp.timestamp || 0,
                            type: 'vote',
                            typeLabel: '‚úÖ –û—Ç–≤–µ—Ç –Ω–∞ –æ–ø—Ä–æ—Å',
                            text: poll.question || '(–±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞)',
                            extra: resp.optionText || (poll.options ? poll.options[resp.optionIndex] : '?'),
                            read: null
                        });
                    }
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                allItems.sort((a, b) => b.time - a.time);

                if (allItems.length === 0) {
                    body.innerHTML = '<div class="history-empty">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</div>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º: —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç—ã
                const messagesHtml = allItems.filter(i => i.type === 'msg' || i.type === 'dm-poll').map(item => renderHistoryItem(item)).join('');
                const votesHtml = allItems.filter(i => i.type === 'vote').map(item => renderHistoryItem(item)).join('');

                let html = '';

                if (messagesHtml) {
                    html += `<div class="profile-section">
                        <div class="profile-section-title">üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${allItems.filter(i => i.type === 'msg' || i.type === 'dm-poll').length})</div>
                        ${messagesHtml}
                    </div>`;
                }

                if (votesHtml) {
                    html += `<div class="profile-section">
                        <div class="profile-section-title">üìä –û—Ç–≤–µ—Ç—ã –Ω–∞ –æ–ø—Ä–æ—Å—ã (${allItems.filter(i => i.type === 'vote').length})</div>
                        ${votesHtml}
                    </div>`;
                }

                body.innerHTML = html;

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
                body.innerHTML = `<div class="history-empty">‚ùå –û—à–∏–±–∫–∞: ${escapeHtml(err.message)}</div>`;
            }
        }

        function renderHistoryItem(item) {
            const time = item.time ? formatDate(item.time) : '‚Äî';
            const typeClass = 'history-type-' + item.type.replace('-', '-');
            const readBadge = item.read === true ? ' ‚úì' : (item.read === false ? ' (–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)' : '');

            let extraHtml = '';
            if (item.type === 'vote') {
                extraHtml = `<div class="history-answer">‚Üí ${escapeHtml(item.extra)}</div>`;
            } else if (item.extra) {
                extraHtml = `<div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.25rem;">${escapeHtml(item.extra)}</div>`;
            }

            return `
                <div class="history-item">
                    <div class="history-meta">
                        <span class="history-type ${typeClass}">${item.typeLabel}${readBadge}</span>
                        <span class="history-time">${time}</span>
                    </div>
                    <div class="history-text">${escapeHtml(item.text)}</div>
                    ${extraHtml}
                </div>
            `;
        }

        function formatDate(timestamp) {
            const d = new Date(timestamp);
            const now = new Date();
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const hours = d.getHours().toString().padStart(2, '0');
            const mins = d.getMinutes().toString().padStart(2, '0');

            if (d.toDateString() === now.toDateString()) {
                return `–°–µ–≥–æ–¥–Ω—è, ${hours}:${mins}`;
            }

            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (d.toDateString() === yesterday.toDateString()) {
                return `–í—á–µ—Ä–∞, ${hours}:${mins}`;
            }

            return `${day}.${month}, ${hours}:${mins}`;
        }

        // ============================================
        // –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ú–£ –ü–û–°–ï–¢–ò–¢–ï–õ–Æ
        // ============================================

        function openDirectMessage(visitorId) {
            const name = getVisitorDisplayName(visitorId) || visitorId.substring(0, 15) + '‚Ä¶';
            const existing = document.querySelector('.modal-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            overlay.innerHTML = `
                <div class="modal">
                    <h3>‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è <span style="color:var(--accent-hover)">${escapeHtml(name)}</span></h3>

                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                        <button class="btn btn-sm btn-outline dm-mode-btn active" data-mode="message" onclick="switchDmMode(this, 'message')">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <button class="btn btn-sm btn-outline dm-mode-btn" data-mode="poll" onclick="switchDmMode(this, 'poll')">üìä –û–ø—Ä–æ—Å</button>
                    </div>

                    <div id="dmMessageForm">
                        <div class="form-group">
                            <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                            <textarea id="dmText" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." style="resize:vertical;"></textarea>
                        </div>
                    </div>

                    <div id="dmPollForm" style="display:none;">
                        <div class="form-group">
                            <label>–í–æ–ø—Ä–æ—Å</label>
                            <input type="text" id="dmPollQuestion" placeholder="–í–æ–ø—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è">
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input type="text" id="dmPollDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ...">
                        </div>
                        <div class="form-group">
                            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã</label>
                            <div id="dmOptionsList" style="display:flex; flex-direction:column; gap:0.5rem;">
                                <input type="text" class="dm-poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1">
                                <input type="text" class="dm-poll-option" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
                            </div>
                            <button class="add-option-btn" style="margin-top:0.5rem;" onclick="addDmOption()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-outline btn-sm" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary btn-sm" onclick="sendDirectMessage('${visitorId}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            `;

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });

            document.body.appendChild(overlay);
        }

        function switchDmMode(btn, mode) {
            document.querySelectorAll('.dm-mode-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'transparent';
                b.style.color = 'var(--text-secondary)';
            });
            btn.classList.add('active');
            btn.style.background = 'rgba(59,130,246,0.15)';
            btn.style.color = 'var(--accent-hover)';

            document.getElementById('dmMessageForm').style.display = mode === 'message' ? 'block' : 'none';
            document.getElementById('dmPollForm').style.display = mode === 'poll' ? 'block' : 'none';
        }

        function addDmOption() {
            const list = document.getElementById('dmOptionsList');
            const count = list.querySelectorAll('.dm-poll-option').length;
            if (count >= 6) { alert('–ú–∞–∫—Å–∏–º—É–º 6'); return; }
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'dm-poll-option';
            input.placeholder = '–í–∞—Ä–∏–∞–Ω—Ç ' + (count + 1);
            list.appendChild(input);
        }

        function sendDirectMessage(visitorId) {
            const isMessageMode = document.getElementById('dmMessageForm').style.display !== 'none';
            const sendBtn = document.querySelector('.modal-actions .btn-primary');
            if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...'; }

            if (isMessageMode) {
                const text = document.getElementById('dmText').value.trim();
                if (!text) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'); if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; } return; }

                db.ref('directMessages/' + visitorId).push({
                    message: text,
                    type: 'message',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                }).then(() => {
                    const overlay = document.querySelector('.modal-overlay');
                    if (overlay) overlay.remove();
                    alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firebase ‚Äî –Ω—É–∂–µ–Ω —É–∑–µ–ª directMessages');
                    if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; }
                });
            } else {
                const question = document.getElementById('dmPollQuestion').value.trim();
                const desc = document.getElementById('dmPollDesc').value.trim();
                const options = [];
                document.querySelectorAll('.dm-poll-option').forEach(input => {
                    if (input.value.trim()) options.push(input.value.trim());
                });

                if (!question) { alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å'); if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; } return; }
                if (options.length < 2) { alert('–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞'); if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; } return; }

                db.ref('directMessages/' + visitorId).push({
                    message: question,
                    description: desc || null,
                    options: options,
                    type: 'poll',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                }).then(() => {
                    const overlay = document.querySelector('.modal-overlay');
                    if (overlay) overlay.remove();
                    alert('‚úÖ –û–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—é!');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firebase ‚Äî –Ω—É–∂–µ–Ω —É–∑–µ–ª directMessages');
                    if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; }
                });
            }
        }

        // ============================================
        // DASHBOARD: –û–ü–†–û–°–´
        // ============================================

        function initPollForm() {
            const addBtn = document.getElementById('addOptionBtn');
            const sendBtn = document.getElementById('sendPollBtn');
            const optionsList = document.getElementById('optionsList');

            addBtn.addEventListener('click', () => {
                const count = optionsList.querySelectorAll('.option-row').length;
                if (count >= 6) {
                    alert('–ú–∞–∫—Å–∏–º—É–º 6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
                    return;
                }
                const row = document.createElement('div');
                row.className = 'option-row';
                row.innerHTML = `
                    <input type="text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç ${count + 1}" class="poll-option">
                    <button class="remove-option" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                `;
                optionsList.appendChild(row);
                bindRemoveButtons();
            });

            sendBtn.addEventListener('click', sendPoll);
            bindRemoveButtons();
        }

        function bindRemoveButtons() {
            document.querySelectorAll('.remove-option').forEach(btn => {
                btn.onclick = function() {
                    const rows = document.querySelectorAll('.option-row');
                    if (rows.length <= 2) {
                        alert('–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞');
                        return;
                    }
                    this.closest('.option-row').remove();
                };
            });
        }

        function sendPoll() {
            const question = document.getElementById('pollQuestion').value.trim();
            const description = document.getElementById('pollDescription').value.trim();
            const optionInputs = document.querySelectorAll('.poll-option');
            const options = [];

            optionInputs.forEach(input => {
                const val = input.value.trim();
                if (val) options.push(val);
            });

            if (!question) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
                return;
            }
            if (options.length < 2) {
                alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞');
                return;
            }

            const pollData = {
                question: question,
                description: description || null,
                options: options,
                active: true,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: auth.currentUser.email
            };

            db.ref('polls').push(pollData)
                .then(() => {
                    document.getElementById('pollQuestion').value = '';
                    document.getElementById('pollDescription').value = '';
                    document.querySelectorAll('.poll-option').forEach(input => input.value = '');
                    alert('‚úÖ –û–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º!');
                })
                .catch(err => {
                    alert('–û—à–∏–±–∫–∞: ' + err.message);
                });
        }

        // --- –°–ø–∏—Å–æ–∫ –æ–ø—Ä–æ—Å–æ–≤ ---
        function listenPolls() {
            db.ref('polls').orderByChild('createdAt').on('value', (snapshot) => {
                const pollsList = document.getElementById('pollsList');
                const polls = [];

                snapshot.forEach(childSnap => {
                    polls.push({ id: childSnap.key, ...childSnap.val() });
                });

                if (polls.length === 0) {
                    pollsList.innerHTML = '<div class="no-data">–û–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }

                polls.reverse();

                pollsList.innerHTML = polls.map(poll => {
                    const statusClass = poll.active ? 'poll-active' : 'poll-closed';
                    const statusText = poll.active ? '‚óè –ê–∫—Ç–∏–≤–µ–Ω' : '‚óã –ó–∞–∫—Ä—ã—Ç';

                    return `
                        <div class="poll-card" id="poll-${poll.id}">
                            <div class="poll-card-header">
                                <div>
                                    <h4>${escapeHtml(poll.question)}</h4>
                                    ${poll.description ? `<p style="font-size:0.85rem; color:var(--text-secondary); margin-top:0.25rem;">${escapeHtml(poll.description)}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0;">
                                    <span class="poll-status ${statusClass}">${statusText}</span>
                                    ${poll.active ?
                                        `<button class="btn btn-danger btn-sm" onclick="closePoll('${poll.id}')">–ó–∞–∫—Ä—ã—Ç—å</button>` :
                                        `<button class="btn btn-outline btn-sm" onclick="deletePoll('${poll.id}')">–£–¥–∞–ª–∏—Ç—å</button>`
                                    }
                                </div>
                            </div>
                            <div class="poll-results" id="results-${poll.id}">
                                <div class="no-data pulse" style="padding: 0.5rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</div>
                            </div>
                        </div>
                    `;
                }).join('');

                polls.forEach(poll => loadPollResults(poll));
            });
        }

        function loadPollResults(poll) {
            db.ref('pollResponses/' + poll.id).on('value', (snapshot) => {
                const responses = snapshot.val() || {};
                const container = document.getElementById('results-' + poll.id);
                if (!container) return;

                const options = poll.options || [];
                const counts = new Array(options.length).fill(0);
                let total = 0;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –æ—Ç–≤–µ—Ç—É
                const voterDetails = [];

                Object.entries(responses).forEach(([visitorId, resp]) => {
                    if (resp.optionIndex >= 0 && resp.optionIndex < options.length) {
                        counts[resp.optionIndex]++;
                        total++;
                        voterDetails.push({
                            visitorId: visitorId,
                            optionIndex: resp.optionIndex,
                            optionText: resp.optionText || options[resp.optionIndex],
                            timestamp: resp.timestamp
                        });
                    }
                });

                if (total === 0) {
                    container.innerHTML = '<div class="no-data" style="padding: 0.5rem;">–û—Ç–≤–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                voterDetails.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                const barsHtml = options.map((opt, i) => {
                    const percent = total > 0 ? (counts[i] / total * 100) : 0;
                    return `
                        <div class="poll-result-row">
                            <span class="poll-result-label">${escapeHtml(opt)}</span>
                            <div class="poll-result-bar-container">
                                <div class="poll-result-bar c${i % 6}" style="width: ${percent}%"></div>
                            </div>
                            <span class="poll-result-count">${counts[i]} (${Math.round(percent)}%)</span>
                        </div>
                    `;
                }).join('');

                const voterRowsHtml = voterDetails.map(v => {
                    const name = getVisitorDisplayName(v.visitorId);
                    const displayName = name || v.visitorId.substring(0, 15) + '‚Ä¶';
                    const colorIdx = v.optionIndex % 6;
                    const colors = ['var(--accent)', 'var(--success)', 'var(--warning)', '#a78bfa', '#f472b6', '#34d399'];
                    return `
                        <div class="poll-voter-row">
                            <span class="poll-voter-name" style="cursor:pointer;" onclick="renameVisitor('${v.visitorId}')" title="–ö–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è">${escapeHtml(displayName)}</span>
                            <span class="poll-voter-answer" style="color:${colors[colorIdx]}">${escapeHtml(v.optionText)}</span>
                        </div>
                    `;
                }).join('');

                const pollCardId = poll.id.replace(/[^a-zA-Z0-9_-]/g, '');

                container.innerHTML = barsHtml +
                    `<div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
                        <button class="poll-details-toggle" onclick="toggleVoterList('voters-${pollCardId}')">üë• –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º (${total})</button>
                        <span style="font-size:0.8rem; color:var(--text-secondary);">–í—Å–µ–≥–æ: ${total}</span>
                    </div>
                    <div class="poll-voter-list" id="voters-${pollCardId}">
                        ${voterRowsHtml}
                    </div>`;
            });
        }

        function toggleVoterList(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('open');
                const btn = el.previousElementSibling.querySelector('.poll-details-toggle');
                if (btn) {
                    btn.textContent = el.classList.contains('open')
                        ? btn.textContent.replace('–ü–æ–∫–∞–∑–∞—Ç—å', '–°–∫—Ä—ã—Ç—å')
                        : btn.textContent.replace('–°–∫—Ä—ã—Ç—å', '–ü–æ–∫–∞–∑–∞—Ç—å');
                }
            }
        }

        function closePoll(pollId) {
            if (confirm('–ó–∞–∫—Ä—ã—Ç—å –æ–ø—Ä–æ—Å? –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –µ–≥–æ –≤–∏–¥–µ—Ç—å.')) {
                db.ref('polls/' + pollId + '/active').set(false);
            }
        }

        function deletePoll(pollId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø—Ä–æ—Å –∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã?')) {
                db.ref('polls/' + pollId).remove();
                db.ref('pollResponses/' + pollId).remove();
            }
        }

        // ============================================
        // –£–¢–ò–õ–ò–¢–´
        // ============================================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
